name: deploy_after_merge

on:
  push:
    branches: 
     - release

jobs:
  job_1:
    name: prefer
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Run a multi-line script
      run: |
        touch ./ios/Runner/GoogleService-Info.plist
        touch ./android/app/google-services.json
        mkdir google

    - name: wget
      uses: wei/wget@v1
      with:
        args: ${{ secrets.FIREBASE_IOS }} -O ./google/GoogleService-Info.plist

    - name: wget
      uses: wei/wget@v1
      with:
        args: ${{ secrets.FIREBASE_ANDROID }} -O ./google/google-services.json

    - uses: actions/upload-artifact@v1
      with:
        name: google
        path: google

  job_2:
    name: flutter
    needs: job_1
    runs-on: macos-latest
    steps:

    - uses: actions/checkout@v2

    - name: Run a multi-line script
      run: |
        touch ./ios/Runner/GoogleService-Info.plist
        touch ./android/app/google-services.json
        mkdir google

    - uses: actions/download-artifact@v1
      with:
        name: google
        path: google

    - name: Run a multi-line script
      run: |
        mv google/GoogleService-Info.plist ./ios/Runner/GoogleService-Info.plist
        mv google/google-services.json ./android/app/google-services.json
        mkdir distribution

    - uses: subosito/flutter-action@v1.1.1
      with:
        channel: 'stable'
          
    - name: flutter pub get
      run: flutter pub get

    - name: flutter build ios
      run: flutter build ios --release --no-codesign

    - name: Run a single-line script
      run: cd ios

    - name: archive ios
      env:
        PERSONAL_ACCESS_TOKEN_GITHUB: ${{ secrets.PERSONAL_ACCESS_TOKEN_GITHUB }}
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      run: fastlane archive

    - name: Run a multi-lines script
      run: |
        cd ..
        mv ios/fastlane/generated/Runner.ipa ./distribution/app-release.ipa

    - name: flutter build android
      run: flutter build apk --release

    - name: Run a single-line script
      run: mv build/app/outputs/apk/release/app-release.apk ./distribution/app-release.apk

    - uses: actions/upload-artifact@v1
      with:
        name: distribution
        path: distribution

  job_3:
    name: distribution
    needs: job_2
    runs-on: ubuntu-latest
    steps:

    - uses: actions/checkout@v2

    - name: Run a single-line script
      run: mkdir distribution

    - uses: actions/download-artifact@v1
      with:
        name: distribution
        path: distribution

    - name: upload artifact to Firebase App Distribution
      uses: wzieba/Firebase-Distribution-Github-Action@v1.1.1
      with:
        appId: ${{secrets.FIREBASE_IOS_APPID}}
        token: ${{secrets.FIREBASE_TOKEN}}
        groups: zwtin
        file: ./distribution/app-release.ipa

    - name: upload artifact to Firebase App Distribution
      uses: wzieba/Firebase-Distribution-Github-Action@v1.1.1
      with:
        appId: ${{secrets.FIREBASE_ANDROID_APPID}}
        token: ${{secrets.FIREBASE_TOKEN}}
        groups: zwtin
        file: ./distribution/app-release.apk

